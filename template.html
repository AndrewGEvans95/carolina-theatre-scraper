<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carolina Theatre Schedule</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Carolina Theatre Schedule</h1>
    
    <div class="tabs">
      <div class="tab" style="background: #3498db; color: #1a1a2e;">Movie Schedule</div>
      <a href="daily-cinema.html" class="tab">The Daily Cinema Club</a>
      <a href="about.html" class="tab">Why This Exists</a>
    </div>
    
    <div id="otherTimesDialog" class="other-times-dialog hidden">
      <div class='other-times-dialog-title'></div>
      <div class="other-times-list"></div>
      <button onclick="closeOtherTimesDialog()">Close</button>
    </div>
    
    <!-- Movie Schedule Content -->
    <div id="schedule" class="tab-content active">
      <div class="filter">
        <div class="filter-group">
          <label for="groupFilter">View:</label>
          <select id="groupFilter" onchange="filterByDay()" aria-label="Group movies by day or movie">
            <option value="by-day">By Day</option>
            <option value="by-movie">By Movie</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="dayFilter">Date:</label>
          <select id="dayFilter" onchange="filterByDay()" aria-label="Filter movies by day">
            <option value="month">This Month</option>
            <option value="week">This Week</option>
            <option value="all">All Days</option>
{{DAY_FILTER_OPTIONS}}
          </select>
        </div>
      </div>
{{SCHEDULE_CONTENT}}
    </div>
    
    <footer>
      <p>"I wish it need not have happened in my time," said Frodo.<br>
      "So do I," said Gandalf, "and so do all who live to see such times. But that is not for them to decide. 
      All we have to decide is what to do with the time that is given us." – J.R.R. Tolkien</p>
    </footer>
  </div>

  <script>


    function filterByDay() {
      var selectedDay = document.getElementById("dayFilter").value;
      var selectedGroup = document.getElementById("groupFilter").value;
      var days = document.querySelectorAll(".day");
      var movieGroups = document.querySelectorAll(".movie-group");
      const today = Date.now();

      function matchesDate(dateString) {
          let movieDate = Date.parse(dateString);
          let difference = (movieDate - today) / (1000 * 60 * 60 * 24);
          if (selectedDay === "week") {
            if (difference <= 7) {
              return true;
            } 
          } else if (selectedDay === "month") {
            if (difference <= 31) {
              return true;
            } 
          } else if (selectedDay === "all" || date === selectedDay) {
            return true;
          }
          return false;
      }

      function hide(element) {
        element.classList.add("hidden");
      }

      function show(element) {
        element.classList.remove("hidden");
      }

      if (selectedGroup === "by-day") {
        days.forEach(function(day) {
          let date = day.getAttribute("data-date");
          if (matchesDate(date)) {
            show(day);
          } else {
            hide(day);
          }
        });
        movieGroups.forEach(hide);
      } else if (selectedGroup === "by-movie") {
        days.forEach(hide);
        // show the group if any of the elements inside of it are inside the requested date range
        movieGroups.forEach(function(group) {
          const movies = group.querySelectorAll(".movie");
          let anyAreVisible = false;
          for(let movie of movies) {
            let date = movie.getAttribute("data-movie-date");
            if (matchesDate(date)) {
              anyAreVisible = true;
            }
          }
          if (anyAreVisible) {
            show(group);
          } else {
            hide(group);
          }
        });
      }
    }

    // On page load, if a hash is present, scroll to that movie and highlight it.
    document.addEventListener("DOMContentLoaded", function() {
      if (window.location.hash) {
        var target = document.getElementById(window.location.hash.substring(1));
        if (target) {
          setTimeout(function() {
            target.scrollIntoView({ behavior: "smooth", block: "center" });
            target.classList.add("highlight");
            setTimeout(function() {
              target.classList.remove("highlight");
            }, 3000);
          }, 100);
        }
      } else {
        filterByDay();
      }
    });

    let allShowtimes = {};
    function showOtherTimes(title, currentTime, currentDate, currentCinema, currentId) {
      let dialog = document.getElementById('otherTimesDialog');
      let list = '';
      let found = false;
      let seenShowtimes = new Set();

      if (allShowtimes[title]) {
        allShowtimes[title].sort((a, b) => {
          return a.formatted_datetime.localeCompare(b.formatted_datetime);
        });

        allShowtimes[title].forEach(function(st) {
          const showtimeKey = `${st.time}-${st.date}-${st.cinema}`;
          
          if (!seenShowtimes.has(showtimeKey) && 
              !(st.time === currentTime && st.date === currentDate && st.cinema === currentCinema)) {
            seenShowtimes.add(showtimeKey);
            let targetId = st.id ? st.id : '';
            const displayDate = st.date || 'Unknown Date';
            list += `<a class='other-times-link' href='#${targetId}' onclick="closeOtherTimesDialog('${targetId}')">${displayDate} — ${st.time} @ ${st.cinema}</a>`;
            found = true;
          }
        });
      }
      if (!found) {
        list = '<div>No other showtimes for this movie.</div>';
      }
      dialog.querySelector('.other-times-list').innerHTML = list;
      dialog.querySelector('.other-times-dialog-title').innerText = `Other Showtimes for: ${title}`;
      dialog.classList.remove("hidden")
    }
    
    function closeOtherTimesDialog(targetId) {
      document.getElementById('otherTimesDialog').classList.add("hidden");

      if (targetId) {
        setTimeout(() => {
          let el = document.getElementById(targetId);
          el.scrollIntoView({behavior:'instant',block:'center'});
          el.classList.add("highlight");
          setTimeout(() => {
            el.classList.remove("highlight");
          }, 1000);
        }, 0);
      }
    }

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeOtherTimesDialog();
      }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
      let seenShowtimes = new Set();
      document.querySelectorAll('[data-movie-title]').forEach(function(el) {
        let title = el.getAttribute('data-movie-title');
        let time = el.getAttribute('data-movie-time');
        let date = el.getAttribute('data-movie-date');
        let cinema = el.getAttribute('data-movie-cinema');
        let formatted_datetime = el.getAttribute('data-formatted-datetime') || '';
        let id = el.getAttribute('id');
        
        if (!title || !time || !date || !cinema) {
          console.warn('Missing data for showtime:', {title, time, date, cinema});
          return;
        }
        
        const showtimeKey = `${title}|${time}|${date}|${cinema}`;
        
        if (!seenShowtimes.has(showtimeKey)) {
          seenShowtimes.add(showtimeKey);
          if (!allShowtimes[title]) allShowtimes[title] = [];
          allShowtimes[title].push({time, date, cinema, id, formatted_datetime});
        }
      });
    });
    
    function copyShareLink(movieId, event) {
      event.preventDefault();
      event.stopPropagation();
      
      const url = window.location.href.split('#')[0] + '#' + movieId;
      const btn = event.currentTarget;
      const originalText = btn.innerHTML;
      window.location.hash = movieId;
      
      function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        let successful = false;
        try {
          successful = document.execCommand('copy');
        } catch (err) {
          console.error('Fallback copy failed:', err);
        }
        
        document.body.removeChild(textArea);
        return successful;
      }
      
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url)
          .then(() => {
            showCopySuccess(btn, originalText);
          })
          .catch(() => {
            if (fallbackCopyToClipboard(url)) {
              showCopySuccess(btn, originalText);
            } else {
              showCopyError(btn, originalText);
            }
          });
      } else {
        if (fallbackCopyToClipboard(url)) {
          showCopySuccess(btn, originalText);
        } else {
          showCopyError(btn, originalText);
        }
      }
    }
    
    function showCopySuccess(btn, originalText) {
      btn.classList.add('copied');
      
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('copied');
      }, 2000);
    }
    
    function showCopyError(btn, originalText) {
      btn.classList.add('error');
      
      const errorMsg = document.createElement('div');
      const linkSpan = `<span style="user-select: all;">${window.location.href.split('#')[0] + '#' + btn.closest('.movie').id}</span>`;
      errorMsg.className = 'copy-error-message';
      errorMsg.innerHTML = 'Click to copy manually: ' + linkSpan;
      
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Close';
      closeBtn.className = "closeBtn";
      closeBtn.onclick = () => {
        document.body.removeChild(errorMsg);
        btn.innerHTML = originalText;
        btn.classList.remove('error');
      };
      
      errorMsg.appendChild(closeBtn);
      document.body.appendChild(errorMsg);
      
      setTimeout(() => {
        if (document.body.contains(errorMsg)) {
          document.body.removeChild(errorMsg);
        }
        btn.innerHTML = originalText;
        btn.classList.remove('error');
      }, 10000);
    }
  </script>
</body>
</html>